name: Online-edit change updating main
on:
  workflow_dispatch:
  push:
    branches:
      - online-edit
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-node@v3
      with:
        node-version: 16
    - run: npm install -g canopy-js
    - name: Update Main from Online-Edit Branch
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      run: |
        set -ex

        rev=$(git rev-parse --short HEAD)

        canopy bulk --finish

        TOPICS_CHANGES=$(git status --porcelain | grep "topics/")
        if [[ ! -z $TOPICS_CHANGES ]]; then
          git fetch origin
          git reset origin/main
          canopy bulk --start
          rm .canopy_bulk_original_selection
          git checkout origin/main -- README.md
          git add -A
          git status
          AUTHOR=$(git log -1 | grep Author | cut -d" " -f2-)
          git commit --author=$AUTHOR -m "$(git log --format=%B -n 1)"
          git push -q origin HEAD:main
        fi
